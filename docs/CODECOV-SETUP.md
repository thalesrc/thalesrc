# Codecov Setup Guide for Thalesrc Monorepo

## Overview

This guide explains how to set up Codecov for individual libraries in the Thalesrc monorepo, ensuring each library has independent coverage tracking and badges.

## Architecture Decision

We use **Codecov Flags** approach for the following reasons:
- ✅ Single Codecov project - easier to manage
- ✅ Independent badges per library
- ✅ Each library uploads coverage independently
- ✅ No dependencies between libraries for coverage
- ✅ Simple GitHub secrets management

## Codecov Admin Panel Setup

### Step 1: Enable Codecov for the Repository

1. Go to [codecov.io](https://codecov.io) and sign in with GitHub
2. Navigate to your organization: **thalesrc**
3. Find the repository: **thalesrc**
4. If not already enabled, click "Setup repo"

### Step 2: Get the Upload Token

1. In the Codecov dashboard for `thalesrc/thalesrc`
2. Go to **Settings** → **General**
3. Find the **Repository Upload Token**
4. Copy this token

### Step 3: Add Token to GitHub Secrets

1. Go to GitHub: `https://github.com/thalesrc/thalesrc/settings/secrets/actions`
2. Click **New repository secret**
3. Name: `CODECOV_TOKEN`
4. Value: Paste the token from Step 2
5. Click **Add secret**

### Step 4: Configure codecov.yml (Root Level)

Create or update `.codecov.yml` in the repository root:

```yaml
# Codecov configuration for Thalesrc monorepo
coverage:
  status:
    project:
      default:
        target: auto
        threshold: 1%
        flags:
          - hermes
          - js-utils
          - ts-utils
          # Add other library flags as needed
    patch:
      default:
        target: auto
        threshold: 1%

# Define flags for each library
flags:
  hermes:
    paths:
      - libs/hermes/src/
    carryforward: true
  
  js-utils:
    paths:
      - libs/js-utils/src/
    carryforward: true
  
  ts-utils:
    paths:
      - libs/ts-utils/src/
    carryforward: true
  
  # Add more libraries as needed...

comment:
  layout: "reach, diff, flags, files"
  behavior: default
  require_changes: false
```

## GitHub Actions Configuration

### For Each Library's Publish Workflow

Update each library's `.github/workflows/{library}.publish.yml` file:

```yaml
- name: Test with Coverage
  run: pnpm nx run {library}:test/coverage  # or appropriate coverage command

- name: Upload Coverage to Codecov
  uses: codecov/codecov-action@v4
  with:
    token: ${{ secrets.CODECOV_TOKEN }}
    files: ./coverage/libs/{library}/coverage-final.json  # Adjust path as needed
    flags: {library}  # e.g., hermes, js-utils
    name: {library}-coverage
    fail_ci_if_error: false
    verbose: true
```

### Example: Hermes Library

See [`.github/workflows/hermes.publish.yml`](../.github/workflows/hermes.publish.yml) for a complete example.

Key points:
- **files**: Path to the coverage file generated by your test runner
- **flags**: Must match the flag name in `.codecov.yml`
- **fail_ci_if_error**: Set to `false` to avoid blocking releases if Codecov has issues
- **verbose**: Helps with debugging

## Coverage Badge URLs

Once configured, add badges to each library's README:

```markdown
[![codecov](https://codecov.io/gh/thalesrc/thalesrc/branch/main/graph/badge.svg?flag=hermes)](https://codecov.io/gh/thalesrc/thalesrc?flag=hermes)
```

Replace `hermes` with the appropriate flag name for each library.

### Badge Format

```
https://codecov.io/gh/{owner}/{repo}/branch/{branch}/graph/badge.svg?flag={library-name}
```

Example URLs:
- Hermes: `https://codecov.io/gh/thalesrc/thalesrc/branch/main/graph/badge.svg?flag=hermes`
- JS Utils: `https://codecov.io/gh/thalesrc/thalesrc/branch/main/graph/badge.svg?flag=js-utils`
- TS Utils: `https://codecov.io/gh/thalesrc/thalesrc/branch/main/graph/badge.svg?flag=ts-utils`

## Adding a New Library

To add Codecov coverage for a new library:

1. **Add flag to `.codecov.yml`**:
   ```yaml
   flags:
     my-new-lib:
       paths:
         - libs/my-new-lib/src/
       carryforward: true
   ```

2. **Update the library's publish workflow**:
   Add the Codecov upload step (see template above)

3. **Add badge to library README**:
   ```markdown
   [![codecov](https://codecov.io/gh/thalesrc/thalesrc/branch/main/graph/badge.svg?flag=my-new-lib)](https://codecov.io/gh/thalesrc/thalesrc?flag=my-new-lib)
   ```

4. **Ensure coverage is generated**:
   - The library must have a test target that generates coverage
   - Common formats: `coverage-final.json`, `lcov.info`, `cobertura.xml`
   - Adjust the `files` path in the workflow accordingly

## Troubleshooting

### Coverage Not Appearing

1. Check that the coverage file path is correct in the workflow
2. Verify the flag name matches in both `.codecov.yml` and the workflow
3. Check GitHub Actions logs for Codecov upload errors
4. Ensure `CODECOV_TOKEN` secret is set correctly

### Badge Not Updating

1. Badges may take a few minutes to update after upload
2. Try hard-refreshing the page (Ctrl+F5)
3. Verify the flag exists in Codecov dashboard
4. Check the badge URL format

### "Coverage Not Found" Error

1. Ensure the library's tests are actually running with coverage enabled
2. Verify the coverage output directory matches the `files` parameter
3. Check that the test command generates the expected coverage format

## Best Practices

1. **Always run coverage in CI**: Ensure your publish workflows run tests with coverage
2. **Don't block on Codecov failures**: Use `fail_ci_if_error: false` to avoid release delays
3. **Keep flags organized**: Use consistent naming (library name = flag name)
4. **Use carryforward**: Set `carryforward: true` so coverage persists when a library isn't updated
5. **Independent libraries**: Each library should generate its own coverage without needing other libraries built

## References

- [Codecov Documentation](https://docs.codecov.com/)
- [Codecov Flags Documentation](https://docs.codecov.com/docs/flags)
- [Codecov Action (GitHub)](https://github.com/codecov/codecov-action)
